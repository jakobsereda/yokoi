use phf::phf_map;
use anyhow::{
    Result, 
    anyhow
};

static CART_TYPE_MAP: phf::Map<u8, &'static str> = phf_map! {
    0x00u8 => "ROM ONLY",
    0x01u8 => "MBC1",
    0x02u8 => "MBC1+RAM",
    0x03u8 => "MBC1+RAM+BATTERY",
    0x05u8 => "MBC2",
    0x06u8 => "MBC2+BATTERY",
    0x08u8 => "ROM+RAM",
    0x09u8 => "ROM+RAM+BATTERY",
    0x0Bu8 => "MMM01",
    0x0Cu8 => "MMM01+RAM",
    0x0Du8 => "MMM01+RAM+BATTERY",
    0x0Fu8 => "MBC3+TIMER+BATTERY",
    0x10u8 => "MBC3+TIMER+RAM+BATTERY",
    0x11u8 => "MBC3",
    0x12u8 => "MBC3+RAM",
    0x13u8 => "MBC3+RAM+BATTERY",
    0x19u8 => "MBC5",
    0x1Au8 => "MBC5+RAM",
    0x1Bu8 => "MBC5+RAM+BATTERY",
    0x1Cu8 => "MBC5+RUMBLE",
    0x1Du8 => "MBC5+RUMBLE+RAM",
    0x1Eu8 => "MBC5+RUMBLE+RAM+BATTERY",
    0x20u8 => "MBC6",
    0x22u8 => "MBC7+SENSOR+RUMBLE+RAM+BATTERY",
    0xFCu8 => "POCKET CAMERA",
    0xFDu8 => "BANDAI TAMA5",
    0xFEu8 => "HuC3",
    0xFFu8 => "HuC1+RAM+BATTERY",
};

static NEW_LICENSEE_CODE_MAP: phf::Map<u16, &'static str> = phf_map! {
    0x3030u16 => "None",
    0x3031u16 => "Nintendo Research & Development 1",
    0x3038u16 => "Capcom",
    0x3133u16 => "EA (Electronic Arts)",
    0x3138u16 => "Hudson Soft",
    0x3139u16 => "B-AI",
    0x3230u16 => "KSS",
    0x3232u16 => "Planning Office WADA",
    0x3234u16 => "PCM Complete",
    0x3235u16 => "San-X",
    0x3238u16 => "Kemco",
    0x3239u16 => "SETA Corporation",
    0x3330u16 => "Viacom",
    0x3331u16 => "Nintendo",
    0x3332u16 => "Bandai",
    0x3333u16 => "Ocean Software/Acclaim Entertainment",
    0x3334u16 => "Konami",
    0x3335u16 => "HectorSoft",
    0x3337u16 => "Taito",
    0x3338u16 => "Hudson Soft",
    0x3339u16 => "Banpresto",
    0x3431u16 => "Ubi Soft",
    0x3432u16 => "Atlus",
    0x3434u16 => "Malibu Interactive",
    0x3436u16 => "Angel",
    0x3437u16 => "Bullet-Proof Software",
    0x3439u16 => "Irem",
    0x3530u16 => "Absolute",
    0x3531u16 => "Acclaim Entertainment",
    0x3532u16 => "Activision",
    0x3533u16 => "Sammy USA Corporation",
    0x3534u16 => "Konami",
    0x3535u16 => "Hi Tech Expressions",
    0x3536u16 => "LJN",
    0x3537u16 => "Matchbox",
    0x3538u16 => "Mattel",
    0x3539u16 => "Milton Bradley Company",
    0x3630u16 => "Titus Interactive",
    0x3631u16 => "Virgin Games Ltd.",
    0x3634u16 => "Lucasfilm Games",
    0x3637u16 => "Ocean Software",
    0x3639u16 => "EA (Electronic Arts)",
    0x3730u16 => "Infogrames",
    0x3731u16 => "Interplay Entertainment",
    0x3732u16 => "Broderbund",
    0x3733u16 => "Sculptured Software",
    0x3735u16 => "The Sales Curve Limited",
    0x3738u16 => "THQ",
    0x3739u16 => "Accolade",
    0x3830u16 => "Misawa Entertainment",
    0x3833u16 => "lozc",
    0x3836u16 => "Tokuma Shoten",
    0x3837u16 => "Tsukuda Original",
    0x3931u16 => "Chunsoft Co.",
    0x3932u16 => "Video System",
    0x3933u16 => "Ocean Software/Acclaim Entertainment",
    0x3935u16 => "Varie",
    0x3936u16 => "Yonezawa/s'pal",
    0x3937u16 => "Kaneko",
    0x3939u16 => "Pack-In-Video",
    0x4134u16 => "Konami (Yu-Gi-Oh!)",
};

static OLD_LICENSEE_CODE_MAP: phf::Map<u8, &'static str> = phf_map! {
    0x00u8 => "None",
    0x01u8 => "Nintendo",
    0x08u8 => "Capcom",
    0x09u8 => "HOT-B",
    0x0Au8 => "Jaleco",
    0x0Bu8 => "Coconuts Japan",
    0x0Cu8 => "Elite Systems",
    0x13u8 => "EA (Electronic Arts)",
    0x18u8 => "Hudson Soft",
    0x19u8 => "ITC Entertainment",
    0x1Au8 => "Yanoman",
    0x1Du8 => "Japan Clary",
    0x1Fu8 => "Virgin Games Ltd.",
    0x24u8 => "PCM Complete",
    0x25u8 => "San-X",
    0x28u8 => "Kemco",
    0x29u8 => "SETA Corporation",
    0x30u8 => "Infogrames",
    0x31u8 => "Nintendo",
    0x32u8 => "Bandai",
    0x33u8 => "None",
    0x34u8 => "Konami",
    0x35u8 => "HectorSoft",
    0x38u8 => "Capcom",
    0x39u8 => "Banpresto",
    0x3Cu8 => "Entertainment Interactive",
    0x3Eu8 => "Gremlin",
    0x41u8 => "Ubi Soft",
    0x42u8 => "Atlus",
    0x44u8 => "Malibu Interactive",
    0x46u8 => "Angel",
    0x47u8 => "Spectrum Holobyte",
    0x49u8 => "Irem",
    0x4Au8 => "Virgin Games Ltd.",
    0x4Du8 => "Malibu Interactive",
    0x4Fu8 => "U.S. Gold",
    0x50u8 => "Absolute",
    0x51u8 => "Acclaim Entertainment",
    0x52u8 => "Activision",
    0x53u8 => "Sammy USA Corporation",
    0x54u8 => "Gametek",
    0x55u8 => "Park Place",
    0x56u8 => "LJN",
    0x57u8 => "Matchbox",
    0x59u8 => "Milton Bradley Company",
    0x5Au8 => "Mindscape",
    0x5Bu8 => "Romstar",
    0x5Cu8 => "Naxat Soft",
    0x5Du8 => "Tradewest",
    0x60u8 => "Titus Interactive",
    0x61u8 => "Virgin Games Ltd.",
    0x67u8 => "Ocean Software",
    0x69u8 => "EA (Electronic Arts)",
    0x6Eu8 => "Elite Systems",
    0x6Fu8 => "Electro Brain",
    0x70u8 => "Infogrames",
    0x71u8 => "Interplay Entertainment",
    0x72u8 => "Broderbund",
    0x73u8 => "Sculptured Software",
    0x75u8 => "The Sales Curve Limited",
    0x78u8 => "THQ",
    0x79u8 => "Accolade",
    0x7Au8 => "Triffix Entertainment",
    0x7Cu8 => "MicroProse",
    0x7Fu8 => "Kemco",
    0x80u8 => "Misawa Entertainment",
    0x83u8 => "LOZC G.",
    0x86u8 => "Tokuma Shoten",
    0x8Bu8 => "Bullet-Proof Software",
    0x8Cu8 => "Vic Tokai Corp.",
    0x8Eu8 => "Ape Inc.",
    0x8Fu8 => "I'Max",
    0x91u8 => "Chunsoft Co.",
    0x92u8 => "Video System",
    0x93u8 => "Tsubaraya Productions",
    0x95u8 => "Varie",
    0x96u8 => "Yonezawa",
    0x97u8 => "Kemco",
    0x99u8 => "Arc",
    0x9Au8 => "Nihon Bussan",
    0x9Bu8 => "Tecmo",
    0x9Cu8 => "Imagineer",
    0x9Du8 => "Banpresto",
    0x9Fu8 => "Nova",
    0xA1u8 => "Hori Electric",
    0xA2u8 => "Bandai",
    0xA4u8 => "Konami",
    0xA6u8 => "Kawada",
    0xA7u8 => "Takara",
    0xA9u8 => "Technos Japan",
    0xAAu8 => "Broderbund",
    0xACu8 => "Toei Animation",
    0xADu8 => "Toho",
    0xAFu8 => "Namco",
    0xB0u8 => "Acclaim Entertainment",
    0xB1u8 => "ASCII Corporation",
    0xB2u8 => "Bandai",
    0xB4u8 => "Square Enix",
    0xB6u8 => "HAL Laboratory",
    0xB7u8 => "SNK",
    0xB9u8 => "Pony Canyon",
    0xBAu8 => "Culture Brain",
    0xBBu8 => "Sunsoft",
    0xBDu8 => "Sony Imagesoft",
    0xBFu8 => "Sammy Corporation",
    0xC0u8 => "Taito",
    0xC2u8 => "Kemco",
    0xC3u8 => "Square",
    0xC4u8 => "Tokuma Shoten",
    0xC5u8 => "Data East",
    0xC6u8 => "Tonkin House",
    0xC8u8 => "Koei",
    0xC9u8 => "UFL",
    0xCAu8 => "Ultra Games",
    0xCBu8 => "VAP, Inc.",
    0xCCu8 => "Use Corporation",
    0xCDu8 => "Meldac",
    0xCEu8 => "Pony Canyon",
    0xCFu8 => "Angel",
    0xD0u8 => "Taito",
    0xD1u8 => "SOFEL (Software Engineering Lab)",
    0xD2u8 => "Quest",
    0xD3u8 => "Sigma Enterprises",
    0xD4u8 => "ASK Kodansha Co.",
    0xD6u8 => "Naxat Soft",
    0xD7u8 => "Copya System",
    0xD9u8 => "Banpresto",
    0xDAu8 => "Tomy",
    0xDBu8 => "LJN",
    0xDDu8 => "Nippon Computer Systems",
    0xDEu8 => "Human Ent.",
    0xDFu8 => "Altron",
    0xE0u8 => "Jaleco",
    0xE1u8 => "Towa Chiki",
    0xE2u8 => "Yutaka",
    0xE3u8 => "Varie",
    0xE5u8 => "Epoch",
    0xE7u8 => "Athena",
    0xE8u8 => "Asmik Ace Entertainment",
    0xE9u8 => "Natsume",
    0xEAu8 => "King Records",
    0xEBu8 => "Atlus",
    0xECu8 => "Epic/Sony Records",
    0xEEu8 => "IGS",
    0xF0u8 => "A Wave",
    0xF3u8 => "Extreme Entertainment",
    0xFFu8 => "LJN",
};

struct Header {
    entry: [u8; 0x4],
    logo: [u8; 0x30],
    title: [u8; 0x10],
    new_lic_code: u16,
    sgb_flag: u8,
    cart_type: u8,
    rom_size: u8,
    ram_size: u8,
    dest_code: u8,
    old_lic_code: u8,
    version: u8,
    checksum: u8,
    global_checksum: u16,
}

pub struct Cartridge {
    header: Header,
    data: Vec<u8>,
}

impl Cartridge {
    pub fn from_bytes(data: &[u8]) -> Result<Self> {
        if data.len() < 0x150 {
            return Err(anyhow!("ROM data is not long enough"))
        }

        let header = Header {
            entry: data[0x100..0x104].try_into()?,
            logo: data[0x104..0x134].try_into()?,
            title: data[0x134..0x144].try_into()?,
            new_lic_code: u16::from_be_bytes([data[0x144], data[0x145]]),
            sgb_flag: data[0x146],
            cart_type: data[0x147],
            rom_size: data[0x148],
            ram_size: data[0x149],
            dest_code: data[0x14A],
            old_lic_code: data[0x14B],
            version: data[0x14C],
            checksum: data[0x14D],
            global_checksum: u16::from_be_bytes([data[0x14E], data[0x14F]]),
        };

        Ok(Self {
            header: header,
            data: data.to_vec(),
        })
    }

    pub fn cart_read(&self, address: u16) -> Result<u8> {
        self.data.get(address as usize).copied()
            .ok_or_else(|| anyhow!("Address out of bounds"))
    }

    pub fn cart_write(&self, address: u16, value: u8) {
        // TODO
    }

    pub fn get_cart_type(&self) -> Result<&'static str> {
        CART_TYPE_MAP.get(&self.header.cart_type).copied()
            .ok_or_else(|| anyhow!("Unknown cartridge type: {:#04x}", self.header.cart_type))
    }

    pub fn get_lic_code(&self) -> Result<&'static str> {
        if self.header.old_lic_code == 0x33 {
            NEW_LICENSEE_CODE_MAP.get(&self.header.new_lic_code).copied()
                .ok_or_else(|| anyhow!("Unknown new licensee code: {:#04x}", self.header.new_lic_code))
        } else {
            OLD_LICENSEE_CODE_MAP.get(&self.header.old_lic_code).copied()
                .ok_or_else(|| anyhow!("Unknown old licensee code: {:#04x}", self.header.old_lic_code))
        }
    }
}

